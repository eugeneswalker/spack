spack:
  view: false

  concretizer:
    reuse: false
    unify: false

  packages:
    all:
      require: "%apple-clang@14.0.0"
      target: [m1]

  compilers:
  - compiler:
      spec: apple-clang@14.0.0
      paths:
        cc: /usr/bin/clang
        cxx: /usr/bin/clang++
        f77: /opt/homebrew/bin/gfortran-12
        fc: /opt/homebrew/bin/gfortran-12
      flags: {}
      operating_system: ventura
      target: aarch64
      modules: []
      environment: {}
      extra_rpaths: []

  specs:
  - bash
  - py-numpy
  - py-scipy
  - py-matplotlib

  mirrors: { "mirror": "s3://spack-binaries/develop/e4s-mac" }

  gitlab-ci:

    script:
    - uname -a || true
    - ls -ld /opt/spack
    - rm -rf /opt/spack/*
    - rm -rf /opt/spack/.* || true
    - cp -r $CI_PROJECT_DIR/* /opt/spack/.
    - export SPACK_DISABLE_LOCAL_CONFIG=1
    - export SPACK_USER_CACHE_PATH=$(pwd)/_user_cache
    - . /opt/spack/share/spack/setup-env.sh
    - spack --version
    - spack arch
    - spack compiler find
    - spack compiler list
    - cd ${SPACK_CONCRETE_ENV_DIR}
    - spack env activate --without-view .
    - mkdir -p ${SPACK_ARTIFACTS_ROOT}/user_data
    - spack --color=always --backtrace ci rebuild --tests > >(tee ${SPACK_ARTIFACTS_ROOT}/user_data/pipeline_out.txt) 2> >(tee ${SPACK_ARTIFACTS_ROOT}/user_data/pipeline_err.txt >&2)

    match_behavior: first
    mappings:
      - match: ['os=ventura']
        runner-attributes:
          tags:
          - apple-clang-14
          - m1
          - macos-ventura

    broken-specs-url: "s3://spack-binaries/broken-specs"

    service-job-attributes:
      before_script:
      - export SPACK_DISABLE_LOCAL_CONFIG=1
      - export SPACK_USER_CACHE_PATH=$(pwd)/.spack-user-cache
      - . share/spack/setup-env.sh
      - spack --version
      tags:
      - apple-clang-14
      - m1
      - macos-ventura

  cdash:
    build-group: E4S MacOS
    url: https://cdash.spack.io
    project: Spack Testing
    site: Cloud Gitlab Infrastructure
